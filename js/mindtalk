/* ===================================================
 * ëª½ì‹¤ëª½ì‹¤ â€” ë‚˜ëŠ” ë‚˜ì—ê²Œ ë¬´ìŠ¨ ë§ì„ í•˜ê³  ìˆì„ê¹Œ?
 * 12ë¬¸í•­ Â· 5ì§€ì„ ë‹¤(0~4) Â· ì‹œê°„ ê°€ì¤‘ì¹˜ Â±20%(ë³´ì¡°)
 * ê²°ê³¼: ì œëª© / ì¸ìš©ë¬¸ / ì„¤ëª… / ê°ì •ìƒíƒœ ìš”ì•½ / ë§ˆìŒ ë¦¬ë§ˆì¸ë“œ / ì‹œê°ìš”ì†Œ / ë²„íŠ¼
 * ìˆ˜ì¹˜ ì ìˆ˜ ë…¸ì¶œ ê¸ˆì§€(ë‚´ë¶€ ê³„ì‚°ë§Œ). %ëŠ” ìƒíƒœ ë¼ë²¨ ë³´ì¡°ë¡œë§Œ ì‚¬ìš© ê°€ëŠ¥.
 * =================================================== */

document.addEventListener('DOMContentLoaded', () => {
  // -------- ë¬¸í•­: K(ë”°ëœ»í•¨), G(ì„±ì¥), N(ë‚´ë©´ ë¹„í‰), A(íšŒí”¼/íšŒí”¼ì  ë°©ì–´) --------
  const Q = [
    {k:'K', q:'ì‹¤ìˆ˜í–ˆì„ ë•Œ â€œê´œì°®ì•„, ëˆ„êµ¬ë‚˜ ê·¸ëŸ´ ìˆ˜ ìˆì–´â€ë¼ê³  ìŠ¤ìŠ¤ë¡œë¥¼ ë‹¬ëœë‹¤.'},
    {k:'K', q:'ì§€ì¹œ ë‚ ì—” ë‚˜ë¥¼ ìœ„í•´ ì‘ì€ ì„ ë¬¼ì´ë‚˜ ì‰¬ëŠ” ì‹œê°„ì„ ë§ˆë ¨í•œë‹¤.'},
    {k:'G', q:'ë¬¸ì œê°€ ìƒê¸°ë©´ ë°°ìš¸ ì ì´ë‚˜ ë‹¤ìŒ ì„ íƒì§€ë¥¼ ë¨¼ì € ë– ì˜¬ë¦°ë‹¤.'},
    {k:'G', q:'ì™„ë²½ë³´ë‹¤ â€œì§„í–‰ ì¤‘(Progress)â€ì„ ë” ì¤‘ìš”í•˜ê²Œ ë³¸ë‹¤.'},
    {k:'N', q:'ì‚¬ì†Œí•œ ì‹¤ìˆ˜ë„ ì˜¤ë˜ ê³±ì”¹ìœ¼ë©° ìŠ¤ìŠ¤ë¡œë¥¼ íƒ“í•œë‹¤.'},
    {k:'N', q:'ì¹­ì°¬ë³´ë‹¤ ë¶€ì¡±í•œ ì ì— ë¨¼ì € ì‹œì„ ì´ ê°„ë‹¤.'},
    {k:'A', q:'ë¶ˆí¸í•œ ê°ì •ì´ ì˜¬ë¼ì˜¤ë©´ ëŒ€í™”ë¥¼ ë¯¸ë£¨ê±°ë‚˜ í”¼í•œë‹¤.'},
    {k:'A', q:'ê°ˆë“± ìƒí™©ì„ ë– ì˜¬ë¦¬ë©´ â€œê·¸ëƒ¥ ë„˜ì–´ê°€ìâ€ê°€ ìì£¼ ë– ì˜¤ë¥¸ë‹¤.'},
    {k:'K', q:'ìš”ì¦˜ì˜ ë‚˜ì—ê²Œ â€œì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´â€ë¼ëŠ” ë§ì„ í•´ì£¼ê³  ì‹¶ë‹¤.'},
    {k:'G', q:'ì‘ì€ ì‹œë„ë¼ë„ í•´ë³´ë©´ ë§ˆìŒì´ í•œê²° ê°€ë²¼ì›Œì§„ë‹¤.'},
    {k:'N', q:'â€œì™œ ì´ê²ƒë°–ì— ëª» í–ˆì§€?â€ì™€ ê°™ì€ ë§ì´ ë¨¸ë¦¿ì†ì—ì„œ ë§´ëˆë‹¤.'},
    {k:'A', q:'í˜ë“  ê°ì •ì„ ë§ë¡œ í‘œí˜„í•˜ëŠ” ì¼ì´ ì–´ë µë‹¤.'}
  ];

  // -------- ìƒíƒœ --------
  let idx = 0;
  const score = {K:0, G:0, N:0, A:0};
  const ans   = [];
  const times = [];
  let startTime = Date.now();

  // -------- DOM --------
  const stepLabel = document.getElementById('stepLabel');
  const barFill   = document.getElementById('barFill');
  const qText     = document.getElementById('qText');
  const wrap      = document.getElementById('choiceWrap');
  const card      = document.getElementById('card');
  const resultBox = document.getElementById('result');
  const prevBtn   = document.getElementById('prev');
  const skipBtn   = document.getElementById('skip');

  // -------- ë Œë” --------
  function render(){
    stepLabel.textContent = `${idx+1} / ${Q.length}`;
    barFill.style.width   = `${(idx/Q.length)*100}%`;
    qText.textContent     = Q[idx].q;

    wrap.innerHTML = `
      <button class="choice" data-s="4" type="button">ë§¤ìš° ê·¸ë ‡ë‹¤</button>
      <button class="choice" data-s="3" type="button">ê·¸ë ‡ë‹¤</button>
      <button class="choice" data-s="2" type="button">ë³´í†µì´ë‹¤</button>
      <button class="choice ghost" data-s="1" type="button">ì•„ë‹ˆë‹¤</button>
      <button class="choice ghost" data-s="0" type="button">ì „í˜€ ì•„ë‹ˆë‹¤</button>
    `;

    // ê¸°ì¡´ ì„ íƒ ë³µì›
    const prevSel = ans[idx];
    if(prevSel !== undefined){
      Array.from(wrap.children).forEach(b=>{
        if(Number(b.dataset.s)===prevSel) b.classList.add('selected');
      });
    }

    Array.from(wrap.children).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        Array.from(wrap.children).forEach(c=>c.classList.remove('selected'));
        btn.classList.add('selected');
        setTimeout(()=>choose(Number(btn.dataset.s)), 160);
      });
    });

    startTime = Date.now();
  }

  // -------- ì‹œê°„ ê°€ì¤‘ì¹˜(ë³´ì¡°) --------
  function w(sec){
    if(sec < 1)  return 0.9;
    if(sec < 4)  return 1.0;
    if(sec < 8)  return 1.15;
    return 1.1;
  }

  // -------- ì‘ë‹µ ì²˜ë¦¬ --------
  function choose(s){
    const elapsed = (Date.now() - startTime)/1000;
    times[idx] = elapsed;

    const k = Q[idx].k;
    const weighted = s + (s * (w(elapsed) - 1) * 0.2); // ì„ íƒ ìš°ì„  + ë³´ì¡°(Â±20% ìº¡)
    score[k] += weighted;
    ans[idx]  = s;

    next();
  }

  function next(){
    idx++;
    if(idx < Q.length) render();
    else finish();
  }

  prevBtn?.addEventListener('click', ()=>{
    if(idx===0) return;
    idx--;
    // ë˜ëŒì•„ê°€ë©´ ì¬ê³„ì‚°
    score.K=score.G=score.N=score.A=0;
    for(let i=0;i<idx;i++){
      const s=ans[i]??0;
      const k=Q[i].k;
      const elapsed=times[i]??4;
      const weighted = s + (s * (w(elapsed) - 1) * 0.2);
      score[k]+=weighted;
    }
    render();
  });

  skipBtn?.addEventListener('click', ()=>{
    ans[idx]=0;
    times[idx]=(Date.now()-startTime)/1000;
    next();
  });

  // -------- ê²°ê³¼ ë¼ë²¨ë§ --------
  const TYPE = {
    K_ONLY: {
      title:'ğŸµ ë”°ëœ»í•œ ì‘ì›ê°€',
      quote:'â€œê´œì°®ì•„, ì˜¤ëŠ˜ì˜ ë‚˜ë¡œ ì¶©ë¶„í•´.â€',
      desc :'ìê¸°ì—°ë¯¼ê³¼ ë‹¤ì •í•¨ì´ ê¸°ë³¸ê°’. ì‹¤íŒ¨ë¥¼ ë‘ë ¤ì›€ë³´ë‹¤ ë°°ì›€ìœ¼ë¡œ ë°”ê¾¸ëŠ” í˜ì´ ìˆì–´ìš”.',
      remind:'ë§ˆìŒì„ ëŒë³´ëŠ” ì†ë„ê°€ ì´ë¯¸ ì¢‹ìŠµë‹ˆë‹¤. ë¦¬ë“¬ì„ ì§€í‚¤ë ¤ë©´ â€œì‘ì€ íœ´ì‹ ì•ŒëŒâ€ì„ í•˜ë£¨ì— í•œ ë²ˆë§Œ ì¶”ê°€í•´ ë³´ì„¸ìš”.'
    },
    G_ONLY: {
      title:'ğŸŒ± ì„±ì¥ ê²©ë ¤ê°€',
      quote:'â€œì–´ì œë³´ë‹¤ í•œ ê±¸ìŒì´ë©´ ë¼.â€',
      desc :'í˜„ì‹¤ì  ë‚™ê´€ì£¼ì˜ì. ë¬¸ì œë¥¼ ë¶„í•´í•˜ê³  ë‹¤ìŒ í–‰ë™ìœ¼ë¡œ ì—°ê²°í•˜ëŠ” ë° ê°•ì ì´ ìˆì–´ìš”.',
      remind:'ê°€ë”ì€ â€œì•„ë¬´ ì¼ë„ ì•ˆ í•˜ëŠ” ì‹œê°„â€ë„ ì„±ì¥ì´ì—ìš”. ë©ˆì¶¤ì´ ë‹¤ìŒ ì „ì§„ì˜ ì¤€ë¹„ì¼ ìˆ˜ ìˆì–´ìš”.'
    },
    N_ONLY: {
      title:'ğŸª ë‚´ë©´ ë¹„í‰ê°€',
      quote:'â€œì˜í•´ì•¼ í•˜ëŠ”ë°â€¦ ì•„ì§ ë¶€ì¡±í•´.â€',
      desc :'ê¸°ì¤€ì´ ë†’ê³  ì±…ì„ê°ì´ ì»¤ì„œ ìŠ¤ìŠ¤ë¡œì—ê²Œ ì—„ê²©í•©ë‹ˆë‹¤. ì¥ì ë„ ì´ë¯¸ ë§ë‹¤ëŠ” ì‚¬ì‹¤ì„ ìŠì§€ ë§ˆì„¸ìš”.',
      remind:'ì˜¤ëŠ˜ì˜ ë§ í•œ ì¤„ì„ ë°”ê¿” ë´ìš”. â€œì™œ ëª»í–ˆì§€?â€ â†’ â€œë¬´ì—‡ì„ í•´ëƒˆì§€?â€'
    },
    A_ONLY: {
      title:'ğŸ«§ íšŒí”¼ ë°©ì–´ê°€',
      quote:'â€œì¼ë‹¨ ë„˜ê¸°ìâ€¦ ë‚˜ì¤‘ì—.â€',
      desc :'ì•ˆì „ì„ ìš°ì„ í•˜ë©° ê°ì •ì„ ì²œì²œíˆ ë‹¤ë£¹ë‹ˆë‹¤. ì†ë„ë¥¼ ë‚´ê¸°ë³´ë‹¤ ë°©í–¥ì„ ìƒì§€ ì•ŠëŠ” í¸ì´ì—ìš”.',
      remind:'ê°ì • í”¼ë¼ë¯¸ë“œ: ì´ë¦„ ë¶™ì´ê¸° â†’ í•œ ì¤„ ê¸°ë¡ â†’ 10ë¶„ ì‚°ì±…. ì•„ì£¼ ì‘ê²Œ ì‹œì‘í•´ë„ ì¶©ë¶„í•´ìš”.'
    },
    KG: {
      title:'ğŸŒ¤ í˜„ì‹¤ ì‘ì›ê°€ (K+G)',
      quote:'â€œë‹¤ì •í•˜ê²Œ, ê·¸ë¦¬ê³  ê¾¸ì¤€í•˜ê²Œ.â€',
      desc :'ìê¸°ë‹¤ì • + ì‹¤í–‰ë ¥ì´ ì¡°í•©ëœ ê±´ê°•í•œ ëª©ì†Œë¦¬. ìŠ¤ìŠ¤ë¡œì—ê²Œ ì œì¼ ì¢‹ì€ ì½”ì¹˜ íƒ€ì….',
      remind:'ì§€ê¸ˆì˜ ë°©ì‹ì´ ì˜ ë§ìŠµë‹ˆë‹¤. ë‹¨, ê³¼í•œ ê³„íšì€ ì¤„ì´ê³  íœ´ì‹ë„ â€œê³„íšâ€ì— ë„£ì–´ ì£¼ì„¸ìš”.'
    },
    KN: {
      title:'ğŸ§­ ì—„ê²© ì‘ì›ê°€ (K+N)',
      quote:'â€œë‹¤ì •í•˜ì§€ë§Œ ê¸°ì¤€ì€ ë¶„ëª…íˆ.â€',
      desc :'ìê¸°ë‹¤ì • ì†ì— ì—„ê²©í•¨ì´ ìˆ¨ì–´ ìˆì–´ìš”. ê¸°ì¤€ì„ ë‚®ì¶”ê¸°ë³´ë‹¤ ê¸°ì¤€ì„ â€œêµ¬ì²´í™”â€í•˜ë©´ ë§ˆìŒì´ í¸í•´ì§‘ë‹ˆë‹¤.',
      remind:'í•˜ë£¨ ëª©í‘œë¥¼ ìµœëŒ€ 3ê°œë¡œ. ì™„ë£Œ ê¸°ì¤€ì„ ë¬¸ì¥ìœ¼ë¡œ ì¨ë‘ë©´ ë‚´ë©´ ë¹„í‰ì´ ì¦ì•„ë“­ë‹ˆë‹¤.'
    },
    GA: {
      title:'ğŸŒˆ ìœ ì—° ì„±ì¥ê°€ (G+A)',
      quote:'â€œì²œì²œíˆ, í•˜ì§€ë§Œ ë©ˆì¶”ì§€ ì•Šê¸°.â€',
      desc :'íšŒí”¼ ì„±í–¥ì„ ì¸ì§€í•˜ë©´ì„œë„ ì‘ê²Œ ì „ì§„í•˜ëŠ” í˜. ì†ë„ë³´ë‹¤ íë¦„ì„ ì¤‘ì‹œí•˜ëŠ” íƒ€ì…ì…ë‹ˆë‹¤.',
      remind:'5ë¶„ë§Œ í•´ë³´ê³  ë©ˆì¶”ê¸° ê·œì¹™. ì‹œì‘ë§Œìœ¼ë¡œë„ ì¶©ë¶„íˆ ì˜ë¯¸ ìˆì–´ìš”.'
    },
    NA: {
      title:'â›… ê· í˜• íƒìƒ‰ê°€ (N+A)',
      quote:'â€œì—„ê²©í•¨ê³¼ ì•ˆì „ ì‚¬ì´ì—ì„œ ê¸¸ì„ ì°¾ëŠ” ì¤‘.â€',
      desc :'ì—„ê²©í•¨ê³¼ íšŒí”¼ê°€ êµì°¨í•©ë‹ˆë‹¤. ë¶€ë‹´ì´ ì»¤ì§ˆìˆ˜ë¡ â€œì‘ê²ŒÂ·êµ¬ì²´ì ìœ¼ë¡œâ€ê°€ í•´ë‹µì´ì—ìš”.',
      remind:'â€œì˜¤ëŠ˜ì˜ ìµœì†Œ ìŠ¹ë¦¬ 1ê°€ì§€â€ë§Œ ì°¾ì. ì•„ì£¼ ì‚¬ì†Œí•´ë„ ì¢‹ì•„ìš”.'
    }
  };

  function classify(sc){
    // ìƒìœ„ 2ì¶•
    const arr = Object.entries(sc).sort((a,b)=>b[1]-a[1]);
    const [k1,v1] = arr[0];
    const [k2,v2] = arr[1];
    const diff = v1 - v2;

    // í™•ì‹¤í•œ ë‹¨ì¼í˜•(ê²©ì°¨ í¼)
    const STRICT = 3.2;
    if(diff >= STRICT) return `${k1}_ONLY`;

    // ì¡°í•©(ì•ŒíŒŒë²³ìˆœì€ ì˜ë¯¸ê°€ ë‹¬ë¼ì„œ ê·œì¹™ ë§¤í•‘)
    const pair = (k1+k2).split('').sort().join('');
    if(pair==='GK') return 'KG';
    if(pair==='KN') return 'KN';
    if(pair==='AG') return 'GA';
    if(pair==='AN') return 'NA';

    // ì˜ˆì™¸ì‹œ K_ONLYë¡œ í´ë°±
    return `${k1}_ONLY`;
  }

  // ìƒíƒœ ë¼ë²¨ (í¼ì„¼íŠ¸ ì•ˆë³´ì´ê³  ë‹¨ì–´ë§Œ)
  function labelFor(p){ if(p>=0.75) return 'ë†’ìŒ'; if(p>=0.5) return 'ì¤‘ê°„'; return 'ë‚®ìŒ'; }

  // ì‹œê°ìš”ì†Œ(ë¼ë²¨í˜• ë¯¸í„°)
  function meters(sc){
    // ì¶• ìµœëŒ€ì¹˜: ê° 3ë¬¸í•­ Ã— 4ì  = 12 (ê°€ì¤‘ ì „/í›„ í° ì°¨ì´ ì—†ê²Œ ì •ê·œí™”)
    const max=12;
    const order=[['K','ë”°ëœ»í•¨'],['G','ì„±ì¥'],['N','ë¹„í‰'],['A','íšŒí”¼']];
    return order.map(([k,name])=>{
      const pct = Math.max(0, Math.min(1, sc[k]/max));
      const w = Math.round(pct*100);
      const tag = labelFor(pct);
      return `
      <div style="margin:6px 0">
        <div style="display:flex;justify-content:space-between;font-weight:700">
          <span>${name}</span><span class="pill" aria-label="${w}%">${tag}</span>
        </div>
        <div style="height:8px;background:var(--mint-200);border-radius:999px;overflow:hidden">
          <span style="display:block;height:100%;width:${w}%;background:var(--mint-500)"></span>
        </div>
      </div>`;
    }).join('');
  }

  function finish(){
    card.style.display='none';
    barFill.style.width='100%';

    const key = classify(score);
    const info = TYPE[key] || TYPE.K_ONLY;

    resultBox.innerHTML = `
      <div class="result-card">
        <div class="result-hero">
          <img src="../assets/mindtalk.png" alt="${info.title}"
               onerror="this.onerror=null; this.src='../assets/mongsil.png'">
          <div>
            <div class="result-title">${info.title}</div>
            <div class="result-desc">${info.quote}</div>
          </div>
        </div>

        <p style="margin:10px 0">${info.desc}</p>

        <div class="state-wrap" style="margin-top:8px">
          ${meters(score)}
        </div>

        <div class="result-section" style="margin-top:10px">
          <div class="pill">ì˜¤ëŠ˜ì˜ ë§ˆìŒ ë¦¬ë§ˆì¸ë“œ</div>
          <p style="margin:8px 0">${info.remind}</p>
        </div>

        <div class="result-actions">
          <a class="start" href="../index.html">ë©”ì¸ìœ¼ë¡œ</a>
          <button class="start" onclick="location.reload()">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸</button>
        </div>
      </div>
    `;
    resultBox.style.display='block';
  }

  // ì‹œì‘
  render();
});