/* ===================================================
 * ëª½ì‹¤ì´ì˜ ì—°ì•  ìŠ¤íƒ€ì¼ í…ŒìŠ¤íŠ¸ (5ì§€ì„ ë‹¤ + 8ìœ í˜• + ë§ˆìŒ ë¦¬ë§ˆì¸ë“œ)
 * ---------------------------------------------------
 * âœ… ì„ íƒ ì ìˆ˜ê°€ ìµœìš°ì„  (0~4: ì „í˜€/ì•„ë‹ˆë‹¤/ë³´í†µ/ê·¸ë ‡ë‹¤/ë§¤ìš°ê·¸ë ‡ë‹¤)
 * âœ… ì‘ë‹µ ì‹œê°„ì€ Â±20% ì´ë‚´ ë³´ì¡° ê°€ì¤‘ì¹˜(ì„ íƒ ë’¤ì—ì§€ ì•ŠìŒ)
 * âœ… ë¶„ë¥˜: ë‹¨ì¼ 4(E,C,S,I) + ì¡°í•© 6(CE,ES,EI,CS,CI,IS) = ì´ 10 ê°€ëŠ¥í•˜ì§€ë§Œ
 *    ì‹¤ì œ í‘œì‹œëŠ” ë‹¨ì¼ 4 + ì¡°í•© 6 â†’ 10ìœ í˜• ì¤‘ ì‘ë‹µì— ë”°ë¼ 8ìœ í˜•ë§Œ ì£¼ë¡œ ë…¸ì¶œ
 * âœ… ê²°ê³¼ ì¹´ë“œ: ì œëª©/ì¸ìš©ë¬¸/ì„¤ëª…/ê°ì • ìƒíƒœ ìš”ì•½/ë§ˆìŒ ë¦¬ë§ˆì¸ë“œ/ì¶•ë³„ ë§‰ëŒ€/ë²„íŠ¼
 * âœ… ìˆ«ì ì ìˆ˜Â·í¼ì„¼íŠ¸ í…ìŠ¤íŠ¸ëŠ” í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ(ë§‰ëŒ€ë§Œ ì‹œê°í™”)
 * =================================================== */

(function(){
  const QUESTIONS = [
    {k:'E',q:'ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒì´ ìƒê¸°ë©´ í‘œí˜„ì„ ì•„ë¼ì§€ ì•ŠëŠ” í¸ì´ë‹¤.'},
    {k:'S',q:'ì—°ì• ì—ì„œë„ ë¯¿ìŒê³¼ ì•ˆì •ê°ì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•œë‹¤.'},
    {k:'C',q:'ëŒ€í™”ê°€ ëŠê¸°ë©´ ë¶ˆì•ˆí•´ì§„ë‹¤.'},
    {k:'I',q:'ì—°ì¸ê³¼ ë–¨ì–´ì ¸ ìˆì–´ë„ ê°ì ì‹œê°„ì„ ì¦ê¸¸ ìˆ˜ ìˆë‹¤.'},
    {k:'E',q:'ê°ì •ì€ ìˆ¨ê¸°ê¸°ë³´ë‹¤ ë°”ë¡œ í‘œí˜„í•˜ëŠ” ê²Œ ì¢‹ë‹¤ê³  ìƒê°í•œë‹¤.'},
    {k:'S',q:'ë¶ˆí™•ì‹¤í•œ ê´€ê³„ë³´ë‹¤ëŠ” í™•ì‹¤íˆ ì •í•´ì§„ ê´€ê³„ê°€ í¸í•˜ë‹¤.'},
    {k:'C',q:'ì„œë¡œì˜ ì¼ìƒì„ ìì£¼ ê³µìœ í•˜ëŠ” ê±¸ ì¢‹ì•„í•œë‹¤.'},
    {k:'I',q:'ì—°ì• ê°€ ë‚˜ë¥¼ êµ¬ì†í•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢‹ê² ë‹¤.'},
    {k:'E',q:'ì—°ì•  ì´ˆë°˜ì— ìŠ¤í‚¨ì‹­ì´ ë¹¨ë¦¬ ëŠ˜ì–´ë‚˜ëŠ” ê±¸ ìì—°ìŠ¤ëŸ½ê²Œ ëŠë‚€ë‹¤.'},
    {k:'S',q:'ì—°ì• ì˜ í•µì‹¬ì€ ì‹ ë¢°ë¼ê³  ìƒê°í•œë‹¤.'},
    {k:'C',q:'ê°ì • í‘œí˜„ì´ ì„œíˆ° ìƒëŒ€ì—ê²Œ ë‹µë‹µí•¨ì„ ëŠë‚€ë‹¤.'},
    {k:'I',q:'ì—°ì¸ì´ ë‚˜ì˜ ì‚¬ìƒí™œì„ ì„¸ì„¸íˆ ì•„ëŠ” ê±´ ë¶€ë‹´ìŠ¤ëŸ½ë‹¤.'},
    {k:'E',q:'ì‚¬ë‘í•œë‹¤ëŠ” ë§ì„ ìì£¼ í•´ì•¼ ê´€ê³„ê°€ ìœ ì§€ëœë‹¤ê³  ìƒê°í•œë‹¤.'},
    {k:'S',q:'í•œ ë²ˆì˜ ì‹¤ìˆ˜ë³´ë‹¤ ì¼ê´€ëœ íƒœë„ê°€ ë” ì¤‘ìš”í•˜ë‹¤.'},
    {k:'I',q:'ì„œë¡œ ì¼ì •í•œ ê±°ë¦¬ê°ì´ ìˆì–´ì•¼ ì˜¤ë˜ê°„ë‹¤ê³  ìƒê°í•œë‹¤.'}
  ];

  let idx = 0;
  const score  = {E:0, S:0, C:0, I:0};   // ê°€ì¤‘ ë°˜ì˜ ëˆ„ì ì ìˆ˜(0~4 ê¸°ì¤€)
  const counts = {E:0, S:0, C:0, I:0};   // ì¶•ë³„ ì‘ë‹µ ë¬¸í•­ìˆ˜
  const ans    = [];                      // ê° ë¬¸í•­ ì›ì ìˆ˜(0~4)
  const times  = [];                      // ê° ë¬¸í•­ ì‘ë‹µ ì‹œê°„(ì´ˆ)
  let startTime = Date.now();

  // DOM
  const stepLabel = document.getElementById('stepLabel');
  const barFill   = document.getElementById('barFill');
  const qText     = document.getElementById('qText');
  const wrap      = document.getElementById('choiceWrap');
  const card      = document.getElementById('card');
  const result    = document.getElementById('result');
  const prevBtn   = document.getElementById('prev');
  const skipBtn   = document.getElementById('skip');

  function render(){
    stepLabel.textContent = `${idx+1} / ${QUESTIONS.length}`;
    barFill.style.width   = `${(idx/QUESTIONS.length)*100}%`;
    qText.textContent     = QUESTIONS[idx].q;

    // 5ì§€ì„ ë‹¤(0~4)
    wrap.innerHTML = `
      <button class="choice" data-s="4">ë§¤ìš° ê·¸ë ‡ë‹¤</button>
      <button class="choice" data-s="3">ê·¸ë ‡ë‹¤</button>
      <button class="choice" data-s="2">ë³´í†µì´ë‹¤</button>
      <button class="choice ghost" data-s="1">ì•„ë‹ˆë‹¤</button>
      <button class="choice ghost" data-s="0">ì „í˜€ ì•„ë‹ˆë‹¤</button>
    `;

    // ì´ì „ ì„ íƒ ë³´ì¡´
    const prevSel = ans[idx];
    if(prevSel !== undefined){
      Array.from(wrap.children).forEach(b=>{
        if(Number(b.dataset.s)===prevSel) b.classList.add('selected');
      });
    }

    // í´ë¦­
    Array.from(wrap.children).forEach(btn=>{
      btn.addEventListener('click',()=>{
        Array.from(wrap.children).forEach(c=>c.classList.remove('selected'));
        btn.classList.add('selected');
        setTimeout(()=>choose(Number(btn.dataset.s)), 160);
      });
    });

    startTime = Date.now();
  }

  function choose(s){
    const elapsed = (Date.now() - startTime)/1000;
    times[idx] = elapsed;

    const k = QUESTIONS[idx].k;
    const w = getWeight(elapsed, k); // 0.8~1.2 ë‚´ ë³´ì¡° ê°€ì¤‘ì¹˜
    ans[idx] = s;

    // ì„ íƒ ìš°ì„  + ì‹œê°„ ë³´ì¡°(Â±20% ìº¡)
    const adjusted = s + (s * (w - 1) * 0.2);
    score[k]  += adjusted;
    counts[k] += 1;

    next();
  }

  function next(){
    idx++;
    if(idx < QUESTIONS.length) render();
    else finish();
  }

  prevBtn?.addEventListener('click', ()=>{
    if(idx===0) return;
    idx--;
    recalc(idx);
    render();
  });

  skipBtn?.addEventListener('click', ()=>{
    ans[idx]   = 0;
    times[idx] = (Date.now() - startTime)/1000;
    next();
  });

  /* ---------- ì‹œê°„ ê°€ì¤‘ì¹˜(ë³´ì¡°) ---------- */
  function getWeight(sec, key){
    let w=1.0;
    if(sec < 1) w=0.9;
    else if(sec < 4) w=1.0;
    else if(sec < 8) w=1.15;
    else w=1.1;

    // ì¶•ë³„ ë¯¸ì„¸ ë³´ì •(ì„ íƒ ë’¤ì—ì§€ ì•ŠìŒ)
    if((key==='E'||key==='C') && sec<2)  w *= 1.05; // ë¹ ë¥¸ ì¦‰ì‘ = í‘œí˜„/êµë¥˜ ì•½ +5%
    if((key==='I'||key==='S') && sec>=4) w *= 1.05; // ì‹ ì¤‘/ì•ˆì • = ì•½ +5%
    return Number(w.toFixed(2));
  }

  /* ---------- ë˜ëŒì•„ê° ì¬ê³„ì‚° ---------- */
  function recalc(end){
    score.E=score.S=score.C=score.I=0;
    counts.E=counts.S=counts.C=counts.I=0;
    for(let i=0;i<end;i++){
      const s = ans[i] ?? 0;
      const k = QUESTIONS[i].k;
      const w = getWeight(times[i] ?? 0, k);
      const adjusted = s + (s * (w - 1) * 0.2);
      score[k]  += adjusted;
      counts[k] += 1;
    }
  }

  /* ---------- ìœ í˜• ë¶„ë¥˜ ---------- */
  const DIFF_SINGLE = 3.0; // ë‹¨ì¼í˜• íŒë‹¨ ìµœì†Œ ê²©ì°¨

  function classify(sc){
    const arr = Object.entries(sc).sort((a,b)=>b[1]-a[1]);
    const [k1,v1] = arr[0];
    const [k2,v2] = arr[1];
    const diff = v1 - v2;
    if(diff >= DIFF_SINGLE) return `${k1}_ONLY`;
    return [k1,k2].sort().join(''); // CE/ES/EI/CS/CI/IS
  }

  /* ---------- ê²°ê³¼ ì¹´í”¼ ---------- */
  const TYPE_COPY = {
    // ë‹¨ì¼í˜• 4
    E_ONLY: { title:'ğŸ’— í‘œí˜„ ìŠ¤íŒŒí¬í˜•',
      quote:'"ë§ˆìŒì€ ì „í•  ë•Œ ì‚´ì•„ë‚œë‹¤!"',
      desc :'ê°ì • í‘œí˜„ê³¼ ì• ì • í”¼ë“œë°±ì´ ë¹ ë¥´ê³  í™•ì‹¤í•´ìš”. ê´€ê³„ì˜ ì˜¨ë„ë¥¼ ëŒì–´ì˜¬ë¦¬ëŠ” ë¦¬ë“œ í”Œë ˆì´ì–´ë¡œ, ìƒëŒ€ì˜ ë§ˆìŒì„ ë‹¨ìˆ¨ì— ì•ˆì‹¬ì‹œí‚¤ëŠ” í˜ì´ ìˆì–´ìš”. ë‹¨, ì†ë„ê°€ ë¹ ë¥¸ ë§Œí¼ ê³¼ì—´ë˜ì§€ ì•Šë„ë¡ íœ´ì‹ê³¼ ì†ë„ ì¡°ì ˆì„ ì±™ê¸°ë©´ ë” ì˜¤ë˜ ë”°ëœ»í•©ë‹ˆë‹¤.' },
    C_ONLY: { title:'ğŸ¤ ê³µê° ë„¤ë¹„ê²Œì´í„°í˜•',
      quote:'"ë„ˆì˜ ë¦¬ë“¬ì„ ë¨¼ì € ë“£ëŠ”ë‹¤."',
      desc :'ìƒëŒ€ì˜ ê°ì • ì‹ í˜¸ë¥¼ ì˜ˆë¯¼í•˜ê²Œ í¬ì°©í•˜ê³ , ëŒ€í™”ë¡œ ì¡°ìœ¨í•˜ëŠ” ë° ê°•í•©ë‹ˆë‹¤. ì‘ì€ í‘œì • ë³€í™”ì—ì„œë„ ì˜ë¯¸ë¥¼ ì½ì–´ ê´€ê³„ì˜ ë§ˆì°°ì„ ë‚®ì¶°ìš”. ë‹¤ë§Œ ê³¼ëª°ì…ìœ¼ë¡œ ì§€ì¹˜ì§€ ì•Šë„ë¡ â€˜ë‚´ ê°ì • ê²½ê³„â€™ë„ ê°€ë” ì ê²€í•´ ì£¼ì„¸ìš”.' },
    S_ONLY: { title:'ğŸ§­ ì‹ ë¢° ì•µì»¤í˜•',
      quote:'"ê¾¸ì¤€í•¨ì´ ì‚¬ë‘ì„ ì§€í‚¨ë‹¤."',
      desc :'ì¼ê´€ì„±ê³¼ ì±…ì„ì„ ì¤‘ì‹œí•´ ì•ˆì „í•œ ê¸°ë°˜ì„ ë§Œë“œëŠ” íƒ€ì…. ì•½ì†ê³¼ ê·œì¹™ ì•ˆì—ì„œ ì„œë¡œì˜ ììœ ë¥¼ ìµœëŒ€í™”í•˜ë ¤ í•©ë‹ˆë‹¤. ê°„í˜¹ ë³€í™”ì— ì‹ ì¤‘í•´ ì†ë„ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆëŠ”ë°, ì‘ì€ ì‹¤í—˜ì„ í†µí•´ ê´€ê³„ì˜ ìœ ì—°ì„±ì„ ëŠ˜ë¦¬ë©´ ë” ë‹¨ë‹¨í•´ì§‘ë‹ˆë‹¤.' },
    I_ONLY: { title:'ğŸ•Šï¸ ììœ  ë°”ëŒí˜•',
      quote:'"ìˆ¨ ì‰´ ê³µê°„ì´ ì‚¬ë‘ì„ ì˜¤ë˜ê°€ê²Œ í•œë‹¤."',
      desc :'ììœ¨ì„±ê³¼ ì†ë„ ì¡°ì ˆì„ ì¤‘ì‹œí•˜ëŠ” ì„±í–¥. ì„œë¡œì˜ ì„¸ê³„ë¥¼ ì¡´ì¤‘í•  ë•Œ ì• ì •ë„ ê¹Šì–´ì§‘ë‹ˆë‹¤. ë‹¤ë§Œ ê±°ë¦¬ ë‘ê¸°ê°€ â€œë¬´ê´€ì‹¬â€ìœ¼ë¡œ ì˜¤í•´ë˜ì§€ ì•Šë„ë¡ ì •ê¸°ì ì¸ ë§ˆìŒ ì²´í¬-ì¸ì„ ê³ë“¤ì´ë©´ ì¢‹ì•„ìš”.' },

    // ì¡°í•©í˜• 6
    CE: { title:'ğŸ’ ë”°ëœ»í•œ ì»¤ë®¤ë‹ˆì¼€ì´í„°í˜• (E+C)',
      quote:'"ë§ˆìŒì€ ë‚˜ëˆ„ê³ , ê·€ëŠ” ì—´ê³ ."',
      desc :'í‘œí˜„ë ¥ê³¼ ê³µê°ë ¥ì´ ëª¨ë‘ ë†’ì€ íƒ€ì…. ë¹ ë¥¸ ì• ì •í‘œí˜„ + ì„¬ì„¸í•œ ê²½ì²­ìœ¼ë¡œ ê´€ê³„ì˜ ì˜¨ë„ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ë†’ì…ë‹ˆë‹¤. ê°ì •ì˜ íë¦„ì„ ì˜ íƒ€ì§€ë§Œ, ê°€ë”ì€ êµ¬ì¡°(ì•½ì†/í•©ì˜)ë„ ê³ë“¤ì´ë©´ ë²ˆì•„ì›ƒì„ ë§‰ì„ ìˆ˜ ìˆì–´ìš”.' },
    ES: { title:'ğŸŒ· ë‹¤ì •í•œ ì‹ ë¢° ë¹Œë”í˜• (E+S)',
      quote:'"ë”°ëœ»í•¨ì„ ê¾¸ì¤€íˆ."',
      desc :'ì• ì •í‘œí˜„ì„ ì¼ê´€ëœ í–‰ë™ìœ¼ë¡œ ì¦ëª…í•˜ëŠ” ìŠ¤íƒ€ì¼. ìƒëŒ€ê°€ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì•ˆì •ê°ì„ ëŠë¼ë©° ì‹ ë¢°ê°€ ë¹ ë¥´ê²Œ ìŒ“ì…ë‹ˆë‹¤. ë‹¨, ê³¼ë„í•œ ì±…ì„ê°ì´ ìŒ“ì´ë©´ ë¬´ê²Œê°€ ëŠ˜ ìˆ˜ ìˆìœ¼ë‹ˆ ê°€ë²¼ìš´ ë†€ì´ë„ ë£¨í‹´ì— ë„£ì–´ ë³´ì„¸ìš”.' },
    EI: { title:'ğŸˆ ìœ ì¾Œí•œ ë…ë¦½í˜• (E+I)',
      quote:'"í•¨ê»˜ì—¬ë„ ê°€ë³ê²Œ, ê°€ë³ì§€ë§Œ ì§„ì‹¬."',
      desc :'í‘œí˜„ì€ ì ê·¹ì ì´ë˜ êµ¬ì†ì€ ì‹«ì€ íƒ€ì…. ë°ê³  ììœ ë¡œìš´ ì—ë„ˆì§€ë¡œ ê´€ê³„ì˜ ë¦¬ë“¬ì„ ë§ì¶¥ë‹ˆë‹¤. ì„œë¡œì˜ â€˜ê°ì ì‹œê°„â€™ì„ ì¡´ì¤‘í•˜ëŠ” í•©ì˜ë§Œ ë¶„ëª…í•˜ë©´ ì¥ê¸°ì ìœ¼ë¡œ ê°€ë¿í•´ìš”.' },
    CS: { title:'ğŸ«¶ ì˜¨ì •ì  ìˆ˜í˜¸ìí˜• (C+S)',
      quote:'"ë§ˆìŒì„ ì§€í‚¤ëŠ” ë°©ë²•ì„ ì•ˆë‹¤."',
      desc :'ê³µê°ê³¼ ì‹ ë¢°ì˜ í•©ìœ¼ë¡œ ì•ˆì •ì ì¸ ì• ì°©ì„ ë§Œë“œëŠ” íƒ€ì…. í¬ê³  ì‘ì€ ëŒë´„ í–‰ë™ì´ ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤. ë‹¤ë§Œ ìŠ¤ìŠ¤ë¡œë¥¼ ë’¤ë¡œ ë¯¸ë£¨ì§€ ì•Šë„ë¡, â€œë‚´ ì—ë„ˆì§€ë„ ì†Œì¤‘â€ ê·œì¹™ì„ ì±™ê²¨ ì£¼ì„¸ìš”.' },
    CI: { title:'ğŸŒ¤ï¸ ë°°ë ¤ì  ë…ë¦½í˜• (C+I)',
      quote:'"ì„œë¡œì˜ ê±°ë¦¬ë„ ì¡´ì¤‘ì´ì•¼."',
      desc :'ì„¬ì„¸í•˜ê²Œ ë°°ë ¤í•˜ì§€ë§Œ ì˜ì¡´ì€ ìµœì†Œí™”í•©ë‹ˆë‹¤. ë§ˆìŒì„ ê±´ì¡°í•˜ê²Œ ë§Œë“¤ì§€ ì•Šë„ë¡, ê°„ë‹¨í•œ ì• ì • ì‹ í˜¸(ì§§ì€ ë¬¸ì/ì´ëª¨ì§€)ë¡œ ì˜¨ë„ë¥¼ ìœ ì§€í•˜ë©´ ì¢‹ì•„ìš”.' },
    IS: { title:'ğŸŒ¿ ì°¨ë¶„í•œ íŒŒíŠ¸ë„ˆì‹­í˜• (I+S)',
      quote:'"ëŠë¦¬ì§€ë§Œ ê²¬ê³ í•˜ê²Œ."',
      desc :'ììœ¨ê³¼ ì•ˆì •ì˜ ì¡°í•©. ê³¼ì¥ ì—†ì´ ë‹´ë°±í•˜ê³  ì˜¤ë˜ ê°€ëŠ” íŒ€ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤. ë³€í™”ë¥¼ ì™„ì „íˆ ë§‰ê¸°ë³´ë‹¤, â€œì‘ì€ ë³€í™” ì‹¤í—˜â€ìœ¼ë¡œ ê· í˜•ì„ ë§ì¶”ë©´ ê´€ê³„ì˜ í™œë ¥ì´ ì‚´ì•„ë‚˜ìš”.' }
  };

  /* ---------- ê°ì • ìƒíƒœ ìš”ì•½ & ë§ˆìŒ ë¦¬ë§ˆì¸ë“œ ---------- */
  function summarizeEmotion(sc){
    // ìƒìœ„ 1~2ì¶•ì„ ê¸°ì¤€ìœ¼ë¡œ ê°„ë‹¨ ì„œìˆ 
    const arr = Object.entries(sc).sort((a,b)=>b[1]-a[1]);
    const top = arr.slice(0,2).map(([k])=>k).join('+');
    const map = {
      'E':'ì˜¤ëŠ˜ì€ í‘œí˜„ ì—ë„ˆì§€ê°€ ë†’ì•„ìš”. ë§ˆìŒì„ ë§ë¡œ/í–‰ë™ìœ¼ë¡œ ì „í•  ë•Œ ë§Œì¡±ê°ì´ ì»¤ì§‘ë‹ˆë‹¤.',
      'C':'ê´€ê³„ì˜ ê²°ì„ ì„¬ì„¸í•˜ê²Œ ë“£ëŠ” ë‚ . ëŒ€í™”ì˜ ë¦¬ë“¬ì„ ì¡ìœ¼ë©´ ì•ˆì •ê°ì´ ì˜¬ë¼ê°€ìš”.',
      'S':'ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë£¨í‹´ê³¼ ì•½ì†ì´ í¸ì•ˆí•¨ì„ ì¤˜ìš”. ì‘ì€ ê³„íšì´ ì¹œì ˆí•œ ì•ˆì „ë²¨íŠ¸!',
      'I':'ê°ì ì‹œê°„ì„ í™•ë³´í•˜ë©´ ë§ˆìŒì˜ íƒ„ë ¥ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤. â€˜ê±°ë¦¬ì˜ ë¯¸í•™â€™ì´ ë¹›ë‚˜ëŠ” ë‚ .'
    };
    const map2 = {
      'E+C':'ë”°ëœ»í•œ í‘œí˜„ê³¼ ê²½ì²­ì´ ê· í˜•ì„ ì´ë£¹ë‹ˆë‹¤. ì˜¨ë„ì™€ ë¦¬ë“¬ì´ ê³ ë¥´ê²Œ ìœ ì§€ë¼ìš”.',
      'E+S':'í‘œí˜„ë ¥ì— ì•ˆì •ê°ì´ ë”í•´ì ¸ ë“ ë“ í•´ìš”. ë‹¤ì •í•¨ì´ ìŠµê´€ì´ ë©ë‹ˆë‹¤.',
      'E+I':'ê°€ë²¼ìš´ ì—ë„ˆì§€ì™€ ì§„ì‹¬ì´ í•¨ê»˜ ìˆì–´ìš”. ê±°ë¦¬ ë‘ê¸°ì™€ ì• ì •í‘œí˜„ì´ ì¡°í™”ë¡­ë„¤ìš”.',
      'C+S':'ê³µê°ê³¼ ì‹ ë¢°ê°€ ë‹¨ë‹¨í•©ë‹ˆë‹¤. ëŠìŠ¨í•˜ì§€ë§Œ ì•ˆì •ì ì¸ ì ‘ì´‰ì´ ì¢‹ì•„ìš”.',
      'C+I':'ë°°ë ¤ì™€ ë…ë¦½ì˜ ì¡°í™”. ê°€ê¹Œì›€ê³¼ ë©€ì–´ì§ ì‚¬ì´ì—ì„œ ê· í˜•ì„ ì˜ ì°¾ìŠµë‹ˆë‹¤.',
      'I+S':'ë‹´ë°±í•˜ê³  ê¾¸ì¤€í•©ë‹ˆë‹¤. ì¡°ìš©í•˜ì§€ë§Œ ì˜¤ë˜ê°€ëŠ” íŒ€ì›Œí¬ê°€ ë§Œë“¤ì–´ì ¸ìš”.'
    };
    const key = arr.length>=2 ? [arr[0][0],arr[1][0]].sort().join('+') : arr[0][0];
    return map2[key] || map[arr[0][0]] || 'ë§ˆìŒì˜ ì†ë„ë¥¼ ìŠ¤ìŠ¤ë¡œ ì •í•˜ë©´ í¸ì•ˆí•´ì§€ëŠ” ë‚ ì´ì—ìš”.';
  }

  function mindReminders(typeKey){
    const base = {
      E: ['í•˜ë£¨ í•œ ë²ˆ, â€œê³ ë§ˆì›Œâ€ë¥¼ ë¨¼ì € ë§í•´ë³´ê¸°', 'ìŠ¤í‚¨ì‹­/ì´ëª¨ì§€ ê°™ì€ ì• ì • ì‹ í˜¸ ë‚¨ê¸°ê¸°', 'ê³¼ì—´ ë°©ì§€: ì§§ì€ íœ´ì‹ íƒ€ì´ë¨¸ 5ë¶„'],
      C: ['ëŒ€í™” ì „ â€œë¬´ìŠ¨ ê°ì •ì¸ì§€â€ í•œ ë¬¸ì¥ìœ¼ë¡œ ì •ë¦¬', 'ìƒëŒ€ ë§ 1ì¤„ ë©”ëª¨ â†’ ê³µê° ë¦¬í”Œë¼ì´', 'ê°ì • ê³¼ëª°ì… ë°©ì§€: ë‚˜ì˜ ê²½ê³„ í•œ ì¤„'],
      S: ['ì•½ì†/í•©ì˜ 1ê°€ì§€ ì—…ë°ì´íŠ¸', 'ì‘ì€ ë£¨í‹´(10ë¶„)ìœ¼ë¡œ ì²´ì˜¨ ìœ ì§€', 'ì˜ˆì™¸ ê·œì¹™ 1ê°œ ë§Œë“¤ê¸°(ìœ ì—°ì„± í™•ë³´)'],
      I: ['í˜¼ì ì¶©ì „ 20~30ë¶„ ì˜ˆì•½', 'ì—°ë½ ë¹ˆë„/ì‹œê°„ëŒ€ í•©ì˜í•˜ê¸°', 'ê°€ë²¼ìš´ ë°ì´íŠ¸(ë¶€ë‹´â†“, ì¦ê±°ì›€â†‘)']
    };
    if(typeKey.endsWith('_ONLY')){
      const k = typeKey[0];
      return base[k] || ['ì˜¤ëŠ˜ì€ ë§ˆìŒì„ ê°€ë³ê²Œ ëŒë³´ëŠ” ë‚ ì´ì—ìš”.'];
    }
    // ì¡°í•©í˜• â†’ ë‘ ì¶• ì„ì–´ì„œ 3~4ê°œ
    const [a,b] = typeKey.split('');
    const pick = (arr,n=2)=>arr.slice(0,n);
    const merged = [
      ...(base[a] ? pick(base[a],2) : []),
      ...(base[b] ? pick(base[b],2) : [])
    ];
    return merged.length ? merged : ['ê´€ê³„ì˜ ë¦¬ë“¬ì„ ê°€ë³ê²Œ ì ê²€í•´ ë³´ì„¸ìš”.'];
  }

  /* ---------- ì¶•ë³„ ë¯¸í„°(ë§‰ëŒ€ë§Œ, ìˆ«ì ìˆ¨ê¹€) ---------- */
  function axisMeters(){
    const keys = ['E','C','S','I'];
    return keys.map(k=>{
      // ìµœëŒ€ì¹˜: ë¬¸í•­ìˆ˜(ê° ì¶• 3~4ê°œ) Ã— 4ì 
      const totalMax = (counts[k] || 0) * 4;
      const raw      = score[k];
      const pct      = totalMax ? Math.max(0, Math.min(100, Math.round((raw / totalMax) * 100))) : 0;
      return `
        <div class="section">
          <div style="display:flex;justify-content:space-between;font-weight:700">
            <span>${({E:'í‘œí˜„',C:'êµë¥˜',S:'ì•ˆì •',I:'ììœ¨'})[k]}</span>
            <span aria-hidden="true" style="color:transparent;user-select:none">0</span>
          </div>
          <div class="meter" role="img" aria-label="${k} ì¶• ìƒëŒ€ì  ê°•ë„">
            <span style="width:${pct}%"></span>
          </div>
        </div>
      `;
    }).join('');
  }

  /* ---------- ê²°ê³¼ ì¶œë ¥ ---------- */
  function finish(){
    card.style.display='none';
    barFill.style.width='100%';

    // ìµœì¢… ìœ í˜•
    const typeKey = classify(score);
    const info = TYPE_COPY[typeKey] || {
      title:'â˜ï¸ ëª½ì‹¤í˜•', quote:'"í•¨ê»˜ ë§ì¶°ê°€ìš”."', desc:'ë°ì´í„°ê°€ ì ì–´ìš”. í•œ ë²ˆ ë” ì‹œë„í•´ë³¼ê¹Œìš”?'
    };

    // ê°ì • ìƒíƒœ ìš”ì•½ & ë§ˆìŒ ë¦¬ë§ˆì¸ë“œ
    const summary = summarizeEmotion(score);
    const reminders = mindReminders(typeKey);

    result.innerHTML = `
      <div class="result-card">
        <div class="result-hero">
          <img src="../assets/love.png" alt="ì—°ì•  ìºë¦­í„°" onerror="this.style.display='none'">
          <div>
            <div class="result-title">${info.title}</div>
            <div class="result-desc">${info.quote}</div>
          </div>
        </div>

        <p style="margin:10px 0">${info.desc}</p>

        <div class="section">
          <div class="section-title">ê°ì • ìƒíƒœ ìš”ì•½</div>
          <div style="background:#fff;border:1px solid var(--mint-200);border-radius:14px;padding:12px">${summary}</div>
        </div>

        <div class="section">
          <div class="section-title">ë§ˆìŒ ë¦¬ë§ˆì¸ë“œ</div>
          <div>
            ${reminders.map(t=>`<span class="pill">${t}</span>`).join('')}
          </div>
        </div>

        <div class="section">
          <div class="section-title">ë‚˜ì˜ ê´€ê³„ ì—ë„ˆì§€</div>
          ${axisMeters()}
        </div>

        <div class="result-actions" style="margin-top:12px">
          <a class="start" href="../index.html">ë©”ì¸ìœ¼ë¡œ</a>
          <button class="start" onclick="location.reload()">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸</button>
        </div>
      </div>
    `;
    result.style.display='block';
  }

  // ì‹œì‘
  render();
})();